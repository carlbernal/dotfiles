#!/bin/bash
# Display TODO, FIXME, BUG, and unchecked markdown tasks in source code

set -euo pipefail

# Configuration
TAGS="TODO|FIXME|BUG|\[ \]"
PRIORITY_ORDER=("BUG" "FIXME" "TODO" "[ ]")
REGEX="(//|#|<!--|--|;|/\*|'|\"|\%|^|^[ \t]*(-|\d+\.))\s*($TAGS)"

# Find project root (git first, then fallback to current directory)
find_root() {
    if GIT_ROOT=$(git rev-parse --show-toplevel 2>/dev/null); then
        echo "$GIT_ROOT"
    else
        # Fallback: look for common project markers
        local dir="$PWD"
        while [[ "$dir" != "/" ]]; do
            if [[ -f "$dir/package.json" ]] || \
                [[ -f "$dir/Cargo.toml" ]] || \
                [[ -f "$dir/go.mod" ]] || \
                [[ -f "$dir/Makefile" ]]; then
            echo "$dir"
            return
            fi
            dir=$(dirname "$dir")
        done
        echo "$PWD"
    fi
}

# Assign priority to each tag
get_priority() {
    local tag="$1"
    for i in "${!PRIORITY_ORDER[@]}"; do
        if [[ "$tag" == "${PRIORITY_ORDER[$i]}" ]]; then
            echo "$i"
            return
        fi
    done
    echo "99"
}

ROOT=$(find_root)

# Run ripgrep and sort by priority
rg --ignore-case --vimgrep "$REGEX" "$ROOT" 2>/dev/null | while IFS=: read -r file line col content; do
# Extract tag from content
tag=$(echo "$content" | grep -oiE "$TAGS" | head -1 | tr '[:lower:]' '[:upper:]')
priority=$(get_priority "$tag")

  # Output with priority prefix for sorting
  echo "${priority}:${file}:${line}:${col}:${content}"
done | sort -t: -k1,1n -k2,2 -k3,3n | cut -d: -f2- || true

# Exit 0 even if no matches
exit 0
